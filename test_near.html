<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEAR Wallet Authentication Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .status-box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            min-height: 60px;
        }
        .step-section {
            border-left: 4px solid #48bb78;
            padding: 20px;
            margin: 20px 0;
            background: #f0fff4;
            border-radius: 0 8px 8px 0;
        }
        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .button {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 5px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
        }
        .button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            background: #edf2f7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            border-left: 4px solid #4299e1;
        }
        .result.error {
            background: #fed7d7;
            border-left-color: #f56565;
            color: #c53030;
        }
        .result.success {
            background: #c6f6d5;
            border-left-color: #48bb78;
            color: #22543d;
        }
        input[type="text"] {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin: 5px;
            width: 200px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }
        .icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåø NEAR Wallet Authentication Test</h1>
        <p class="subtitle">Bu sayfa MintroAI backend'inin NEAR Wallet ile authentication s√ºrecini test eder.</p>
        
        <!-- Wallet Status -->
        <div class="status-box">
            <h3>üîê Wallet Durumu:</h3>
            <div id="walletStatus">üîç NEAR Wallet aranƒ±yor...</div>
            
            <button class="button" onclick="manualCheck()" style="margin-top: 10px;">
                üîÑ Manual Check
            </button>
        </div>

        <!-- Step 1: Connect Wallet -->
        <div class="step-section">
            <div class="step-title">
                <span class="icon">üîó</span> Step 1: Connect Wallet
            </div>
            
            <button class="button" id="connectBtn" onclick="connectWallet()">Connect NEAR Wallet</button>
            
            <div id="connectResult"></div>
        </div>

        <!-- Step 2: Request Challenge -->
        <div class="step-section">
            <div class="step-title">
                <span class="icon">üéØ</span> Step 2: Request Challenge
            </div>
            
            <button class="button" id="challengeBtn" onclick="requestChallenge()" disabled>Get Challenge</button>
            
            <div id="challengeResult"></div>
        </div>

        <!-- Step 3: Sign Message -->
        <div class="step-section">
            <div class="step-title">
                <span class="icon">‚úçÔ∏è</span> Step 3: Sign Message
            </div>
            
            <button class="button" id="signBtn" onclick="signMessage()" disabled>Sign Message</button>
            
            <div id="signResult"></div>
        </div>

        <!-- Step 4: Verify Signature -->
        <div class="step-section">
            <div class="step-title">
                <span class="icon">‚úÖ</span> Step 4: Verify Signature
            </div>
            
            <button class="button" id="verifyBtn" onclick="verifySignature()" disabled>Verify Signature</button>
            
            <div id="verifyResult"></div>
        </div>

        <!-- Step 5: Get Account Info -->
        <div class="step-section">
            <div class="step-title">
                <span class="icon">üìä</span> Step 5: Get Account Info
            </div>
            
            <button class="button" id="accountBtn" onclick="getAccountInfo()" disabled>Get Account Info</button>
            
            <div id="accountResult"></div>
        </div>

        <!-- Step 6: Logout -->
        <div class="step-section">
            <div class="step-title">
                <span class="icon">üö™</span> Step 6: Logout
            </div>
            
            <button class="button" id="logoutBtn" onclick="logout()" disabled>Logout</button>
            
            <div id="logoutResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1/auth';
        
        let currentAccount = null;
        let challengeData = null;
        let signatureData = null;
        let authToken = null;

        // Initialize when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, checking for wallets...');
            setTimeout(checkNearWallet, 1000);
        });
        
        // Also check when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM ready, checking for wallets...');
                setTimeout(checkNearWallet, 1000);
            });
        } else {
            console.log('DOM already ready, checking for wallets...');
            setTimeout(checkNearWallet, 1000);
        }

        async function checkNearWallet() {
            console.log('Checking for NEAR Wallet...');
            
            // Check for real NEAR wallets
            if (typeof window.near !== 'undefined') {
                console.log('NEAR Wallet detected!');
                return await initializeNearWallet();
            }
            
            if (typeof window.nearWallet !== 'undefined') {
                console.log('NEAR Wallet detected!');
                return await initializeNearWallet();
            }
            
            // Try NEAR API connection
            try {
                const { connect, keyStores, WalletConnection } = window.nearApi || {};
                if (connect && keyStores && WalletConnection) {
                    console.log('NEAR API detected!');
                    return await initializeNearConnection();
                }
            } catch (e) {
                console.log('NEAR API not available:', e);
            }
            
            // No wallet found, show manual input option
            document.getElementById('walletStatus').innerHTML = 
                `‚ùå NEAR Wallet not found!<br><br>
                <strong>Setup Instructions:</strong><br>
                1. Install NEAR Wallet browser extension<br>
                2. Or use <a href="https://wallet.near.org" target="_blank">web wallet</a><br>
                3. Create a testnet account<br>
                4. Refresh this page<br><br>
                <strong>Alternative:</strong><br>
                You can test with a manual account ID below:<br>
                <input type="text" id="manualAccount" placeholder="your-account.near" style="margin: 5px; padding: 5px;" value="moralice4651.near">
                <button onclick="useManualAccount()" style="padding: 5px 10px;">Use Account</button>`;
        }

        async function initializeNearWallet() {
            try {
                document.getElementById('walletStatus').innerHTML = '‚úÖ NEAR Wallet detected!';
                
                // Try to get current account
                if (window.near && window.near.account) {
                    currentAccount = window.near.account.accountId;
                    updateWalletStatus();
                    document.getElementById('challengeBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Error initializing NEAR Wallet:', error);
                document.getElementById('walletStatus').innerHTML = 
                    `‚ö†Ô∏è NEAR Wallet found but error occurred: ${error.message}`;
            }
        }

        async function initializeNearConnection() {
            try {
                document.getElementById('walletStatus').innerHTML = '‚úÖ NEAR API detected!';
                
                // Initialize connection to NEAR testnet
                const { connect, keyStores, WalletConnection } = window.nearApi;
                const keyStore = new keyStores.BrowserLocalStorageKeyStore();
                
                const config = {
                    networkId: 'testnet',
                    keyStore,
                    nodeUrl: 'https://rpc.testnet.near.org',
                    walletUrl: 'https://wallet.testnet.near.org',
                    helperUrl: 'https://helper.testnet.near.org',
                    explorerUrl: 'https://explorer.testnet.near.org',
                };
                
                const nearConnection = await connect(config);
                const wallet = new WalletConnection(nearConnection, 'mintroai-auth-test');
                
                if (wallet.isSignedIn()) {
                    currentAccount = wallet.getAccountId();
                    updateWalletStatus();
                    document.getElementById('challengeBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Error initializing NEAR connection:', error);
                document.getElementById('walletStatus').innerHTML = 
                    `‚ö†Ô∏è NEAR connection error: ${error.message}`;
            }
        }
        
        // Manual check function
        function manualCheck() {
            document.getElementById('walletStatus').innerHTML = 'üîç Manual check starting...';
            
            console.log('=== NEAR Wallet Debug Info ===');
            console.log('window.near:', window.near);
            console.log('window.nearApi:', window.nearApi);
            console.log('window.nearWallet:', window.nearWallet);
            console.log('navigator.userAgent:', navigator.userAgent);
            
            setTimeout(() => {
                checkNearWallet();
            }, 100);
        }

        function useManualAccount() {
            const accountId = document.getElementById('manualAccount').value.trim();
            if (accountId) {
                currentAccount = accountId;
                updateWalletStatus();
                document.getElementById('challengeBtn').disabled = false;
                
                // Clear previous results
                document.getElementById('connectResult').innerHTML = '';
                document.getElementById('challengeResult').innerHTML = '';
                document.getElementById('signResult').innerHTML = '';
                document.getElementById('verifyResult').innerHTML = '';
                document.getElementById('accountResult').innerHTML = '';
                document.getElementById('logoutResult').innerHTML = '';
                
                console.log('Manual account set:', accountId);
            } else {
                alert('Please enter a valid NEAR account ID');
            }
        }

        function updateWalletStatus() {
            if (currentAccount) {
                document.getElementById('walletStatus').innerHTML = 
                    `‚úÖ Connected: <strong>${currentAccount}</strong>`;
            }
        }

        async function connectWallet() {
            try {
                // For manual testing, just show connected status
                if (currentAccount) {
                    document.getElementById('connectResult').innerHTML = 
                        `<div class="result success">‚úÖ Already connected to: ${currentAccount}</div>`;
                    return;
                }
                
                throw new Error('No NEAR Wallet available. Please use manual account input.');
                
            } catch (error) {
                document.getElementById('connectResult').innerHTML = 
                    `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function requestChallenge() {
            try {
                console.log('Requesting challenge for:', currentAccount);
                
                const requestBody = {
                    protocol: 'near',
                    wallet_address: currentAccount
                };
                
                console.log('Request body:', requestBody);
                
                const response = await fetch(`${API_BASE}/challenge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    challengeData = data;
                    document.getElementById('challengeResult').innerHTML = 
                        `<div class="result success">Challenge received:
Nonce: ${data.nonce}
Message: ${data.message}</div>`;
                    
                    document.getElementById('signBtn').disabled = false;
                } else {
                    throw new Error(JSON.stringify(data) || 'Challenge request failed');
                }
                
            } catch (error) {
                console.error('Challenge request error:', error);
                document.getElementById('challengeResult').innerHTML = 
                    `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function signMessage() {
            try {
                document.getElementById('signResult').innerHTML = 
                    `<div class="result">üîê NEAR Wallet Signing

Trying to sign the challenge message with NEAR Wallet...</div>`;
                
                // Try to use real NEAR wallet for signing
                if (window.near) {
                    try {
                        const signature = await window.near.signMessage({
                            message: challengeData.message,
                            recipient: 'mintroai.near'
                        });
                        
                        signatureData = {
                            signature: signature.signature,
                            public_key: signature.publicKey,
                            message: challengeData.message,
                            address: currentAccount
                        };

                        document.getElementById('signResult').innerHTML = 
                            `<div class="result success">‚úÖ Message signed with NEAR Wallet!
Signature: ${signature.signature.substring(0, 30)}...
Public Key: ${signature.publicKey.substring(0, 30)}...</div>`;
                        
                        document.getElementById('verifyBtn').disabled = false;
                        return;
                        
                    } catch (nearError) {
                        console.error('NEAR Wallet signing failed:', nearError);
                    }
                }
                
                // Fallback: Manual input
                document.getElementById('signResult').innerHTML = 
                    `<div class="result">‚ö†Ô∏è NEAR Wallet signing not available

Please sign this message manually:

<textarea readonly style="width: 100%; height: 100px; margin: 10px 0;">${challengeData.message}</textarea>

Then paste your signature and public key:

<div style="margin: 10px 0;">
    <label>Signature:</label><br>
    <input type="text" id="manualSignature" placeholder="ed25519:..." style="width: 100%; margin: 5px 0;">
</div>

<div style="margin: 10px 0;">
    <label>Public Key:</label><br>
    <input type="text" id="manualPublicKey" placeholder="ed25519:..." style="width: 100%; margin: 5px 0;" value="ed25519:6at32fEyg3aL9wuqGDCNgwPkDkSLTU4WAqWn1YF2gHSt">
</div>

<button onclick="useManualSignature()" class="button">Use Manual Signature</button></div>`;
                
            } catch (error) {
                document.getElementById('signResult').innerHTML = 
                    `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        function useManualSignature() {
            const signature = document.getElementById('manualSignature').value.trim();
            const publicKey = document.getElementById('manualPublicKey').value.trim();
            
            if (!signature || !publicKey) {
                alert('Please provide both signature and public key');
                return;
            }
            
            // Remove ed25519: prefix from signature if present
            const cleanSignature = signature.startsWith('ed25519:') ? signature.substring(8) : signature;
            
            signatureData = {
                signature: cleanSignature,
                public_key: publicKey,
                message: challengeData.message,
                address: currentAccount
            };

            document.getElementById('signResult').innerHTML = 
                `<div class="result success">‚úÖ Manual signature set!
Signature: ${cleanSignature.substring(0, 30)}...
Public Key: ${publicKey.substring(0, 30)}...</div>`;
            
            document.getElementById('verifyBtn').disabled = false;
        }

        async function verifySignature() {
            try {
                console.log('Verifying signature...');
                console.log('Challenge data:', challengeData);
                console.log('Signature data:', signatureData);
                
                const requestBody = {
                    protocol: 'near',
                    wallet_address: currentAccount,
                    signature: signatureData.signature,
                    nonce: challengeData.nonce,
                    public_key: signatureData.public_key
                };
                
                console.log('Verify request body:', requestBody);
                
                const response = await fetch(`${API_BASE}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Verify response status:', response.status);
                const data = await response.json();
                console.log('Verify response data:', data);
                
                if (response.ok) {
                    authToken = data.access_token;
                    document.getElementById('verifyResult').innerHTML = 
                        `<div class="result success">üéâ Authentication successful!
Access Token: ${data.access_token.substring(0, 30)}...
Expires: ${data.expires_at}</div>`;
                    
                    document.getElementById('accountBtn').disabled = false;
                    document.getElementById('logoutBtn').disabled = false;
                } else {
                    throw new Error(JSON.stringify(data) || 'Verification failed');
                }
                
            } catch (error) {
                console.error('Verification error:', error);
                document.getElementById('verifyResult').innerHTML = 
                    `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function getAccountInfo() {
            try {
                const response = await fetch(`${API_BASE}/account/near/${currentAccount}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('accountResult').innerHTML = 
                        `<div class="result success">üìä Account Information:
Address: ${data.address}
Protocol: ${data.protocol}
Valid: ${data.valid}
Network: ${data.network}
Account Type: ${data.account_type}
Balance: ${data.balance || 'Not available'}
Last Activity: ${data.last_activity || 'Not available'}</div>`;
                } else {
                    throw new Error(data.detail || 'Failed to get account info');
                }
                
            } catch (error) {
                document.getElementById('accountResult').innerHTML = 
                    `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        wallet_address: currentAccount,
                        protocol: 'near'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Clear all data
                    authToken = null;
                    challengeData = null;
                    signatureData = null;
                    
                    document.getElementById('logoutResult').innerHTML = 
                        `<div class="result success">‚úÖ Logout successful!</div>`;
                    
                    // Reset buttons
                    document.getElementById('challengeBtn').disabled = true;
                    document.getElementById('signBtn').disabled = true;
                    document.getElementById('verifyBtn').disabled = true;
                    document.getElementById('accountBtn').disabled = true;
                    document.getElementById('logoutBtn').disabled = true;
                    
                    // Clear results
                    setTimeout(() => {
                        document.getElementById('challengeResult').innerHTML = '';
                        document.getElementById('signResult').innerHTML = '';
                        document.getElementById('verifyResult').innerHTML = '';
                        document.getElementById('accountResult').innerHTML = '';
                        document.getElementById('logoutResult').innerHTML = '';
                    }, 3000);
                    
                } else {
                    throw new Error(data.detail || 'Logout failed');
                }
                
            } catch (error) {
                document.getElementById('logoutResult').innerHTML = 
                    `<div class="result error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>